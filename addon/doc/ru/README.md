# nvda-console-toolkit
Console Toolkit - это дополнение NVDA, которое обеспечивает улучшение доступности для консоли Windows, также известной как командная строка. Оно также хорошо работает в Windows PowerShell. Некоторые функции могут работать в альтернативных терминалах, таких как Cygwin, PuTTY и Windows Terminal, однако дополнение было тщательно протестировано только с консолью Windows по умолчанию. Пользователи SSH могут найти это дополнение особенно удобным.

Некоторые из функций ранее были частью [дополнения Tony's enhancements](https://github.com/mltony/nvda-tonys'enhancements/).

## Загрузки

Установить из магазина дополнений.

## Перейти к первой видимой строке
Дополнение Console toolkit переопределяет команду ``shift+numpad7`` в консолях UIA: вместо чтения первой строки во всём буфере теперь читается первая видимая строка в верхней части окна. Нажмите `shift+numpad7` дважды, чтобы вернуться к старому поведению и прочитать первую строку буфера.

## Проговаривание содержимого консоли в реальном времени

Эта опция заставляет NVDA произносить новые строки сразу же после их появления в консольном выводе, вместо того чтобы ставить новые речевые фразы в очередь. Например, если NVDA занята проговариванием строки, появившейся на экране 1 минуту назад, а теперь появляется новая строка, эта опция отменит проговаривание старой строки и сразу же начнёт проговаривать новую, обеспечивая тем самым более оперативную обратную связь с происходящим в окне консоли.

## Звуковой сигнал при обновлении консоли

Эта опция подаёт низкий звуковой сигнал каждый раз, когда обновляется текст в консоли.

## Обеспечение работы Control+V в консолях

Эта опция заставляет сочетание Control+V работать в сессиях `ssh`.

## Экспериментально: редактирование командной строки

Примечание: эта функция является экспериментальной. Пожалуйста, внимательно прочитайте этот раздел и убедитесь, что вы понимаете, как она работает, прежде чем сообщать о проблемах.

Нажмите `NVDA+E`, чтобы определить текущую командную строку в окне консоли и отредактировать ее в доступном окне "Edit prompt". После редактирования вы можете либо нажать `Escape` для обновления текущей командной строки, либо `Enter` для обновления и немедленного выполнения команды. Также вы можете нажать `Alt+F4`, чтобы закрыть окно приглашения к редактированию без обновления командной строки.

Эта возможность была протестирована в командной строке Windows `cmd.exe`, а также в оболочке bash через ssh-соединения, а также в WSL и cygwin. Возможно, она будет работать и в альтернативных оболочках Unix, однако это не было проверено.

Вот как дополнение извлекает текущую команду.
1. Нажимает клавишу `End`, а затем посылает управляющий символ, который является редким символом Unicode и вряд ли будет использоваться где-либо.
2. Затем нажимается клавиша `home` и посылается ещё один управляющий символ.
3. Затем ждёт появления управляющих символов на экране, что может занять некоторое время при медленном SSH-соединении.
4. Команда - это то, что появляется между двумя управляющими символами.
5. Когда в настройках NVDA включена опция "Использовать автоматизацию пользовательского интерфейса для доступа к консоли Windows, когда она доступна", она отправляет ещё один управляющий символ в начало строки. Это необходимо для корректного разбора многострочных команд: Реализация UIA обрезает пробелы в конце каждой строки, поэтому, чтобы определить, есть ли пробел между двумя строками, нам нужно сдвинуть их на один символ. Однако обратите внимание, что таким образом мы не сохраняем количество пробелов между словами, а только гарантируем сохранение наличия пробелов.
6. Перед редактированием дополнения обязательно удалите управляющие символы, установив курсор в начало и конец и имитируя нажатие клавиш `Delete` и `Backspace`.
7. Представляет команду в окне "Edit prompt" для просмотра или редактирования.
8. После того как пользователь нажимает `Enter` или `Escape`, он сначала стирает текущую строку в консоли.  Это достигается одним из четырёх методов, выбор метода настраивается. В настоящее время поддерживаются четыре метода:
    - `Control+C`: работает как в `cmd.exe`, так и в `bash`, но оставляет предыдущую подсказку видимой на экране; не работает в emacs; иногда ненадёжен при медленных SSH-соединениях
    - `Escape`: работает только в `cmd.exe`"),
    - `Control+A Control+K`: работает в `bash` и `emacs`; не работает в `cmd.exe`.
    - `Backspace` (рекомендуется): работает во всех средах; однако медленнее и может привести к повреждению, если длина строки изменилась
9. Затем дополнение имитирует нажатие клавиш для ввода обновлённой команды и, по желанию, имитирует нажатие клавиши `Enter`.

Устранение неполадок:
- Убедитесь, что клавиши 'Home', 'End', 'Delete' и 'Backspace' работают в вашей консоли так, как ожидается.
- Убедитесь, что ваша консоль поддерживает символы Юникода. Некоторые ssh-соединения не поддерживают Юникод.
- Убедитесь, что выбранный метод удаления работает в вашей консоли.

## Экспериментальная функция: захват вывода команд

Примечание: эта функция является экспериментальной. Пожалуйста, внимательно прочитайте этот раздел и убедитесь, что вы понимаете, как она работает, прежде чем сообщать о проблемах.

Находясь в командной строке или в окне "Edit prompt", нажмите `Control+Enter` для захвата вывода команд. Это дополнение способно захватывать большой вывод, охватывающий несколько экранов, хотя при выводе более 10 экранов процесс захвата занимает значительное время. Дополнение воспроизведёт длинный звук, который будет длиться до тех пор, пока дополнение будет захватывать вывод текущей команды, или пока не будет достигнут тайм-аут. В качестве альтернативы, нажмите `NVDA+E`, чтобы прервать захват.

Если в настройках NVDA включена функция "Use UI Automation to access the Windows Console when available", вы можете переключаться на другие окна во время захвата. Однако если эта опция отключена, то NVDA использует устаревший код консоли, который работает только при фокусировке consoel, и поэтому переключение на любое другое окно приостановит захват.

Перехват команд работает путём перенаправления вывода команды на команду `less`. По умолчанию к командам добавляется суффикс:
```
|less -c 2>&1
```
Пожалуйста, изменяйте его только в том случае, если вы знаете, что делаете. Это дополнение знает, как взаимодействовать с выводом команды `less` для получения вывода страницы за страницей.

В Windows инструмент `less.exe` должен быть установлен отдельно. Вы можете установить его через cygwin или скачать двоичный файл для Windows в другом месте.

Если вы используете `tmux` или `screen` в Linux, убедитесь, что внизу не отображается строка состояния. В `tmux` запустите 
```
tmux set status off
```
чтобы избавиться от строки состояния, или измените файл `tmux.conf`.

Устранение неполадок:
- После неудачной попытки захвата вывода нажмите `UpArrow` в консоли, чтобы проверить, какая команда была выполнена.
- Вернитесь к стандартному суффиксу захвата, о котором говорилось выше.
- Попробуйте выполнить шаги по устранению неполадок из раздела "Редактирование командной строки".